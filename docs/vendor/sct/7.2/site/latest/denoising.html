

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" />
  <meta name="readthedocs-addons-api-version" content="1"><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Denoising Data with Components &mdash; tedana 25.1.1a3.dev2+ge0932906e documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="_static/theme_overrides.css?v=ef81f6ce" />

  
    <link rel="shortcut icon" href="_static/tedana_favicon.png"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=643184eb"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="_static/copybutton.js?v=f281be69"></script>
      <script src="https://cdn.rawgit.com/chrisfilo/zenodo.js/v0.1/zenodo.js"></script>
    <script src="_static/js/theme.js"></script>
    <script src="_static/js/versions.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="TE (In)Dependence Models" href="dependence_metrics.html" />
    <link rel="prev" title="tedana.utils.millisec2sec" href="generated/tedana.utils.millisec2sec.html" /> 
<script async type="text/javascript" src="/_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="tedana" /><meta name="readthedocs-version-slug" content="latest" /><meta name="readthedocs-resolver-filename" content="/denoising.html" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            tedana
          </a>
              <div class="switch-menus">
                <div class="version-switch"></div>
                <div class="language-switch"></div>
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi-echo.html">About multi-echo fMRI</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using tedana from the command line</a></li>
<li class="toctree-l1"><a class="reference internal" href="approach.html">tedana’s denoising approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="outputs.html">Outputs of tedana</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_decision_trees.html">Understanding and building a component selection process</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support and communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to tedana</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">The tedana roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Denoising Data with Components</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#remove-all-noise-correlated-fluctuations-aggressive-denoising">Remove all noise-correlated fluctuations (“aggressive” denoising)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#remove-noise-correlated-fluctuations-that-aren-t-correlated-with-fluctuations-in-accepted-components-non-aggressive-denoising">Remove noise-correlated fluctuations that aren’t correlated with fluctuations in accepted components (“non-aggressive” denoising)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#orthogonalize-the-noise-components-w-r-t-the-accepted-components-prior-to-denoising">Orthogonalize the noise components w.r.t. the accepted components prior to denoising</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ME-ICA/tedana/releases">What's New</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">tedana</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Denoising Data with Components</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/denoising.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="denoising-data-with-components">
<h1>Denoising Data with Components<a class="headerlink" href="#denoising-data-with-components" title="Link to this heading"></a></h1>
<p>Decomposition-based denoising methods like <code class="docutils literal notranslate"><span class="pre">tedana</span></code> will produce two important outputs:
component time series and component classifications.
The component classifications will indicate whether each component is “good” (accepted) or “bad” (rejected).
To remove noise from your data, you can regress the “bad” components out of it,
though there are multiple ways to accomplish this.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This page assumes that you have reviewed the component classifications produced by <code class="docutils literal notranslate"><span class="pre">tedana</span></code> already,
and that you agree with those classifications.
If you think some components were misclassified,
you can find instructions for reviewing and changing classifications in
<a class="reference internal" href="faq.html#manual-classification"><span class="std std-ref">[tedana] Can I manually reclassify components?</span></a>.</p>
</div>
<p>By default, <code class="docutils literal notranslate"><span class="pre">tedana</span></code> will perform a regression including both “good” and “bad” components,
and then will selectively remove the “bad” components from the data.
This is colloquially known as “non-aggressive denoising”.</p>
<p>However, users may wish to apply a different type of denoising,
or to incorporate other regressors into their denoising step,
and we will discuss these alternatives here.</p>
<p><code class="docutils literal notranslate"><span class="pre">tedana</span></code> uses independent component analysis (ICA) to decompose the data into components
which each have a spatial map of weights and time series that are assumed to reflect meaningful underlying signals.
It then classifies each component as “accepted” (BOLD-like) or “rejected” (non-BOLD-like).
The data are denoised by taking the time series of the rejected components and regressing them from the data.</p>
<p><code class="docutils literal notranslate"><span class="pre">tedana</span></code> uses a spatial ICA, which means the components are <cite>statistically independent</cite> across space, not time.
That means the time series from accepted and rejected components can share variance.
If a rejected component shares meaningful variance with an accepted component,
then regressing the rejected components’ time series from your data may also remove meaningful signal
associated with the accepted component as well.
Depending on the application,
people may take different approaches on how to handle variance that is shared between accepted and rejected components.
These different approaches towards decomposition-based denoising methods are described here.</p>
<p>This page has three purposes:</p>
<ol class="arabic simple">
<li><p>Describe different approaches to denoising using ICA components.</p></li>
<li><p>Provide sample code that performs each type of denoising.</p></li>
<li><p>Describe how to incorporate external regressors (e.g., motion parameters) into the denoising step.</p></li>
</ol>
<div class="admonition-which-should-you-use admonition">
<p class="admonition-title">Which should you use?</p>
<p>The decision about which denoising approach you should use depends on a number of factors.</p>
<p>The first thing to know is that aggressive denoising, while appropriate for orthogonal time series,
may remove signal associated with “good” time series that are independent to, but not orthogonal with,
the “bad” time series being regressed out.</p>
<p>As an alternative, users may want to try non-aggressive denoising or aggressive denoising combined with component orthogonalization.</p>
<p>The main difference between the orthogonalization+aggressive and non-aggressive approaches is that,
with orthogonalization,
all the variance common across the accepted and rejected components is put in the accepted basket,
and therefore it is not removed in the nuisance regression.
In contrast, with the non-aggressive denoising,
the shared variance is smartly split during the estimation process and therefore some amount is removed.</p>
</div>
<p>Now we can get started!
This walkthrough will show you how to perform different kinds of denoising on example data.</p>
<p>For this walkthrough, we will use Python and the Nilearn package to denoise data that were preprocessed in fMRIPrep.
However, you can definitely accomplish all of these steps in other languages, like MATLAB,
or using other neuroimaging toolboxes, like AFNI.</p>
<p>Let’s start by loading the necessary data.
No matter which type of denoising you want to use, you will need to include this step.</p>
<p>For this, you need the mixing matrix, the data you’re denoising, a brain mask,
and an index of “bad” components.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># A library for working with tabular data</span>

<span class="c1"># Files from fMRIPrep</span>
<span class="n">data_file</span> <span class="o">=</span> <span class="s2">&quot;sub-01_task-rest_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz&quot;</span>
<span class="n">mask_file</span> <span class="o">=</span> <span class="s2">&quot;sub-01_task-rest_desc-brain_mask.nii.gz&quot;</span>
<span class="n">confounds_file</span> <span class="o">=</span> <span class="s2">&quot;sub-01_task-rest_desc-confounds_timeseries.tsv&quot;</span>

<span class="c1"># Files from tedana (after running on fMRIPrepped data)</span>
<span class="n">mixing_file</span> <span class="o">=</span> <span class="s2">&quot;sub-01_task-rest_desc-ICA_mixing.tsv&quot;</span>
<span class="n">metrics_file</span> <span class="o">=</span> <span class="s2">&quot;sub-01_task-rest_desc-tedana_metrics.tsv&quot;</span>

<span class="c1"># Load the mixing matrix</span>
<span class="n">mixing_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">mixing_file</span><span class="p">)</span>  <span class="c1"># Shape is time-by-components</span>

<span class="c1"># Load the component table</span>
<span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">metrics_file</span><span class="p">)</span>
<span class="n">rejected_columns</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;Component&quot;</span><span class="p">]</span>
<span class="n">accepted_columns</span> <span class="o">=</span> <span class="n">metrics_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metrics_df</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;accepted&quot;</span><span class="p">,</span> <span class="s2">&quot;Component&quot;</span><span class="p">]</span>

<span class="c1"># Load the fMRIPrep confounds file</span>
<span class="n">confounds_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">confounds_file</span><span class="p">)</span>

<span class="c1"># Select external nuisance regressors we want to use for denoising</span>
<span class="n">confounds</span> <span class="o">=</span> <span class="n">confounds_df</span><span class="p">[</span>
    <span class="p">[</span>
        <span class="s2">&quot;trans_x&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trans_y&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trans_z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rot_x&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rot_y&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rot_z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;csf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;white_matter&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># Select &quot;bad&quot; components from the mixing matrix</span>
<span class="n">rejected_components</span> <span class="o">=</span> <span class="n">mixing_df</span><span class="p">[</span><span class="n">rejected_columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">accepted_components</span> <span class="o">=</span> <span class="n">mixing_df</span><span class="p">[</span><span class="n">accepted_columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
<section id="remove-all-noise-correlated-fluctuations-aggressive-denoising">
<h2>Remove all noise-correlated fluctuations (“aggressive” denoising)<a class="headerlink" href="#remove-all-noise-correlated-fluctuations-aggressive-denoising" title="Link to this heading"></a></h2>
<p>If you regress just nuisance regressors (i.e., rejected components) out of your data,
then retain the residuals for further analysis, you are doing “aggressive” denoising.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># A library for working with numerical data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.maskers</span><span class="w"> </span><span class="kn">import</span> <span class="n">NiftiMasker</span>  <span class="c1"># A class for masking and denoising fMRI data</span>

<span class="c1"># Combine the rejected components and the fMRIPrep confounds into a single array</span>
<span class="n">regressors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rejected_components</span><span class="p">,</span> <span class="n">confounds</span><span class="p">))</span>

<span class="n">masker</span> <span class="o">=</span> <span class="n">NiftiMasker</span><span class="p">(</span>
    <span class="n">mask_img</span><span class="o">=</span><span class="n">mask_file</span><span class="p">,</span>
    <span class="n">standardize_confounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">smoothing_fwhm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">low_pass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">high_pass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">t_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># This shouldn&#39;t be necessary since we aren&#39;t bandpass filtering</span>
    <span class="n">reports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Denoise the data by fitting and transforming the data file using the masker</span>
<span class="n">denoised_img_2d</span> <span class="o">=</span> <span class="n">masker</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">confounds</span><span class="o">=</span><span class="n">regressors</span><span class="p">)</span>

<span class="c1"># Transform denoised data back into 4D space</span>
<span class="n">denoised_img_4d</span> <span class="o">=</span> <span class="n">masker</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">denoised_img_2d</span><span class="p">)</span>

<span class="c1"># Save to file</span>
<span class="n">denoised_img_4d</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
    <span class="s2">&quot;sub-01_task-rest_space-MNI152NLin2009cAsym_desc-aggrDenoised_bold.nii.gz&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="remove-noise-correlated-fluctuations-that-aren-t-correlated-with-fluctuations-in-accepted-components-non-aggressive-denoising">
<h2>Remove noise-correlated fluctuations that aren’t correlated with fluctuations in accepted components (“non-aggressive” denoising)<a class="headerlink" href="#remove-noise-correlated-fluctuations-that-aren-t-correlated-with-fluctuations-in-accepted-components-non-aggressive-denoising" title="Link to this heading"></a></h2>
<p>If you include both nuisance regressors and regressors of interest in your regression,
you are doing “non-aggressive” denoising.</p>
<p>Unfortunately, non-aggressive denoising is difficult to do with <code class="xref py py-mod docutils literal notranslate"><span class="pre">nilearn</span></code>’s Masker
objects, so we will end up using <a class="reference external" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="(in NumPy v2.3)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy</span></code></a> directly for this approach.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># A library for working with numerical data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.masking</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_mask</span><span class="p">,</span> <span class="n">unmask</span>  <span class="c1"># Functions for (un)masking fMRI data</span>

<span class="c1"># Apply the mask to the data image to get a 2d array</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">apply_mask</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">)</span>

<span class="c1"># Fit GLM to accepted components, rejected components and nuisance regressors</span>
<span class="c1"># (after adding a constant term)</span>
<span class="n">regressors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">confounds</span><span class="p">,</span>
        <span class="n">rejected_components</span><span class="p">,</span>
        <span class="n">accepted_components</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">mixing_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">regressors</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Denoise the data using the betas from just the bad components</span>
<span class="n">confounds_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">confounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_components</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">pred_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">confounds</span><span class="p">,</span> <span class="n">rejected_components</span><span class="p">)),</span> <span class="n">betas</span><span class="p">[</span><span class="n">confounds_idx</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">data_denoised</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">pred_data</span>

<span class="c1"># Save to file</span>
<span class="n">denoised_img</span> <span class="o">=</span> <span class="n">unmask</span><span class="p">(</span><span class="n">data_denoised</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">)</span>
<span class="n">denoised_img</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
    <span class="s2">&quot;sub-01_task-rest_space-MNI152NLin2009cAsym_desc-nonaggrDenoised_bold.nii.gz&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="orthogonalize-the-noise-components-w-r-t-the-accepted-components-prior-to-denoising">
<h2>Orthogonalize the noise components w.r.t. the accepted components prior to denoising<a class="headerlink" href="#orthogonalize-the-noise-components-w-r-t-the-accepted-components-prior-to-denoising" title="Link to this heading"></a></h2>
<p>If you want to ensure that variance shared between the accepted and rejected components does not contaminate the denoised data,
you may wish to orthogonalize the rejected components with respect to the accepted components.
This way, you can regress the rejected components out of the data in the form of what we call “pure evil” components.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tedana</span></code> workflow’s <code class="docutils literal notranslate"><span class="pre">--tedort</span></code> option performs this orthogonalization automatically and
writes out a separate mixing matrix file.
However, this orthogonalization only takes the components into account,
so you will need to separately perform the orthogonalization yourself if you have other regressors you want to account for.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># A library for working with numerical data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nilearn.maskers</span><span class="w"> </span><span class="kn">import</span> <span class="n">NiftiMasker</span>  <span class="c1"># A class for masking and denoising fMRI data</span>

<span class="c1"># Combine the confounds and rejected components in a single array</span>
<span class="n">bad_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rejected_components</span><span class="p">,</span> <span class="n">confounds</span><span class="p">))</span>

<span class="c1"># Regress the good components out of the bad time series to get &quot;pure evil&quot; regressors</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">accepted_components</span><span class="p">,</span> <span class="n">bad_timeseries</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pred_bad_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">accepted_components</span><span class="p">,</span> <span class="n">betas</span><span class="p">)</span>
<span class="n">orth_bad_timeseries</span> <span class="o">=</span> <span class="n">bad_timeseries</span> <span class="o">-</span> <span class="n">pred_bad_timeseries</span>

<span class="c1"># Once you have these &quot;pure evil&quot; components, you can denoise the data</span>
<span class="n">masker</span> <span class="o">=</span> <span class="n">NiftiMasker</span><span class="p">(</span>
    <span class="n">mask_img</span><span class="o">=</span><span class="n">mask_file</span><span class="p">,</span>
    <span class="n">standardize_confounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">smoothing_fwhm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">low_pass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">high_pass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">t_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># This shouldn&#39;t be necessary since we aren&#39;t bandpass filtering</span>
    <span class="n">reports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Denoise the data by fitting and transforming the data file using the masker</span>
<span class="n">denoised_img_2d</span> <span class="o">=</span> <span class="n">masker</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">confounds</span><span class="o">=</span><span class="n">orth_bad_timeseries</span><span class="p">)</span>

<span class="c1"># Transform denoised data back into 4D space</span>
<span class="n">denoised_img_4d</span> <span class="o">=</span> <span class="n">masker</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">denoised_img_2d</span><span class="p">)</span>

<span class="c1"># Save to file</span>
<span class="n">denoised_img_4d</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
    <span class="s2">&quot;sub-01_task-rest_space-MNI152NLin2009cAsym_desc-orthAggrDenoised_bold.nii.gz&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="generated/tedana.utils.millisec2sec.html" class="btn btn-neutral float-left" title="tedana.utils.millisec2sec" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dependence_metrics.html" class="btn btn-neutral float-right" title="TE (In)Dependence Models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2025, tedana developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>